---
title: Simulations
author: "AG"
date: '`r Sys.Date()`'
output: 
  html_document:
    toc: true
    toc_float: true
    theme: paper
classoption: a4paper, oneside
documentclass: article
fontsize: 11pt
csl: elsevier_titles.csl
bibliography: bib.bib
---

# Rationale

We want to show that Gaussian quadrature performs well even in situations where analytical formulae are available.

# Simulation strategies

## Simulation 1: analytical formulae against Gaussian quadrature

We run 1000 simulations under different scenarios, assuming a Weibull baseline hazard with shape parameter \(p\) = 1 and scale parameter \(\lambda\) = 0.5. We generate survival times \(s\) using the approach of Bender _et al_.[@bender_2005]; we generate censoring time \(c\) using the same approach, but without including covariates in the calculation. Then, the observed time will be defined as \(t = \text{min}(s, c)\) and the event indicator variable as \(d = I(s \le c)\).

We compare the use of analytical formulae against Gaussian quadrature with varying number of nodes (15, 35, 75, 105) under the the following scenarios:

1- combinations of number of individuals per cluster (25, 50, 100, 500, 1000) and number of clusters (25, 50, 100, 200);

2- treatment effect: positive 0.5, negative -0.5, null 0.0;

3- variance of the frailty term: small 0.25, medium 0.50, large 1.00.

## Simulation 2: log-normal frailty

We run 1000 simulations under different scenarios, assuming a Weibull baseline hazard with shape parameter \(p\) = 1.5 and scale parameter \(\lambda\) = 3.0. We generate survival times as in simulation n. 1, varying:

1- combinations of number of individuals per cluster (25, 50, 100, 500, 1000) and number of clusters (25, 50, 100, 200);

2- treatment effect: positive 0.5, negative -0.5, null 0.0;

3- variance of the frailty term: small 0.25, medium 0.50, large 1.00.

## Reporting

We report on:

1- average estimate of interest \(\bar{\hat{\beta}} = 1 / B \times \sum_{i = 1}^B \hat{\beta}_i\), and median estimate of interest;

2- average within-simulation standard error [SE] \(\sum_{i = 1} ^ B \text{SE}(\hat{\beta}_i) / B\) and median within-simulation standard error;

3- empirical SE \(\sqrt{\left[ 1 / (B - 1) \right] \sum_{i = 1} ^ B (\hat{\beta}_i - \bar{\hat{\beta}}) ^ 2}\);

4- bias \(\delta = \bar{\hat{\beta}} - \beta\), and percentage bias \(\frac{\bar{\hat{\beta}} - \beta} {\beta} \times 100\);

5- mean square error \((\bar{\hat{\beta}} - \beta) ^ 2 + \text{SE}(\hat{\beta}) ^ 2\);

6- coverage probability, i.e. the proportion of times the \(100(1 - \alpha)\%\) confidence interval \(\hat{\beta}_i \pm Z_{1-\alpha/2} \times \text{SE}(\hat{\beta}_i)\) include \(\beta\), \(\forall i = 1, \dots, B\).

# Statistical methods

## Weibull parametric survival model

We use a Weibull parametric survival model with a Gamma frailty term via the proportional hazards parametrisation:

\[
h(t_i) = h_0(t) g(X_i),
\]

with \(g(X_i)\) non-negative function of the covariates, usually \(g(X_i) = \exp(X_i \beta)\).

In our setting:

\[
h_0(t) = p t ^ {p - 1},
\]

the survivor function is

\[
S(t) = \exp(-\lambda_i t_i ^ p)
\]

with parametrisation

\[
\lambda_i = \exp(X_i \beta).
\]

Hence, the Weibull parametric survival model has hazard function:

\[
h(t) = p \lambda t ^ {p - 1}.
\]

The individual contribution to the likelihood is:

\[
L_i = h(t_i) ^ d_i S(t_i),
\]

where \(d_i\) is the event indicator variable.

The overall likelihood is the product of the individual contributions:

\[
L = \prod_{i = 1} ^ n L_i.
\]

Taking the natural logarithm of the likelihood for ease of computation:

\[
\begin{aligned}
\log L &= \sum_{i = 1} ^ n \left[ d_i \log f_i(t_i) + (1 - d_i) \log S_i(t_i) \right] = \\
       &= \sum_{i = 1} ^ n \left[ d_i \log h_i(t_i) + \log S_i(t_i) \right]
\end{aligned}
\]

## Frailty models

A frailty model is a survival model with unobservable heterogeneity. At the observation level, the frailty is introduced as an unobservable multiplicative effect \(\alpha\) on the hazard function:

\[
h(t | \alpha) = \alpha h(t)
\]

The survivor function given the frailty can be written as:

\[
S(t | \alpha) = \cdots = S(t) ^ \alpha
\]

As \(\alpha\) is unobservable, it must be integrated out of \(S(t | \alpha)\) to obtain the unconditional survivor function:

\[
S_{\theta}(t) = \int S(t|\alpha)g(\alpha) \ d\alpha = \int \left[ S(t) \right] ^ \alpha g(\alpha) \ d\alpha
\]

Given the unconditional survivor function, we can obtain the unconditional hazard and density (and consequently the likelihood) in the usual way:

\[
f_{\theta}(t) = - \frac{d}{dt} S_{\theta}(t) 
\]

\[
h_{\theta}(t) = \frac{f_{\theta}(t)}{S_{\theta}(t)}
\]

A common choice for the frailty distribution \(g(\alpha)\) is the Gamma distribution. In particular, for mathematical tractability, a \(Gamma(1/\theta, \theta)\) distribution is often used. 

A \(Gamma(a, b)\) distribution has probability density function 

\[
g(x) = \frac{x ^ {a - 1} \exp(-x / b)}{\Gamma(a) b ^ a}.
\]

Using the aforementioned \(Gamma(1 / \theta, \theta)\) distribution, the survivor function conditional on the frailty can be written as:

\[
S_\theta(t) = \left[ 1 - \theta \log \left\{ S(t) \right\} \right] ^ {-1 / \theta}
\]

Thus, it follows that the log-likelihood can be written as:

\[
\log L = \sum_{i = 1} ^ n \left[ d_i \log h_i(t_i) - (\theta ^ {-1} + d_i) \log \left\{ 1 - \theta \log S_i(t_i) \right\} \right]
\]

## Shared-frailty models

A generalisation of frailty models is the shared-frailty model, where the frailty is assumed to be group-specific. For observation \(j\) from the \(i\)-th group, the hazard is:

\[
h_{ij}(t | \alpha_i) = \alpha_i h_{ij}(t),
\]

where \(h_{ij}(t) = h(t | X_{ij})\), i.e. the individual hazard given covariates \(X_{ij}\).

In a shared frailty model, the frailty is common to a group of observations. Thus, to form an unconditional likelihood, the frailties must be integrated out at the group level. 

The contribution to the likelihood for the \(ij\)-th individual, given \(\alpha_i\):

\[
L_{ij}(\alpha_i) = S_{ij}(t_{ij}) ^ {\alpha_i} \left[ \alpha_i h_{ij}(t_{ij}) \right] ^ {d_{ij}}
\]

Define \(D_i = \sum_j d_{ij}\) as the number of failures in the \(i\)-th group. The log-likelihood contribution for the \(i\)-th group is:

\[
L_i(\alpha_i) = \alpha_i ^ {D_i} \prod_{j = 1} ^ {n_i} \left[ S_{ij}(t_{ij}) ^ {\alpha_i} \left( h_{ij}(t_{ij}) \right) ^ {d_{ij}} \right]
\]

Integrating out \(\alpha_i\), we can obtain the unconditional contribution to the likelihood:

\[
L_i = \int L_i(\alpha_i) g(\alpha_i) \ d \alpha_i
\]

If the frailty is Gamma-distributed, it is possible to derive an analytical form for the group contribution to the likelihood:

\[
\begin{aligned}
\log L_i =& \sum_{j = 1} ^ {n_i} d_{ij} \log h_{ij}(t_{ij}) - (1 / \theta + D_i) \log \left\{ 1 - \theta \sum_{j = 1} ^ {n_i} \log S_{ij}(t_{ij}) \right\} + \\
          &D_i \log \theta + \log \Gamma(1 / \theta + D_i) - \log \Gamma(1 / \theta),
\end{aligned}
\]

with the overall log-likelihood being, for $N$ clusters,

\[
\log L = \sum_{i = 1} ^ {N} \log L_i. 
\]

## Gaussian quadrature

In numerical analysis, a quadrature rule is an approximation of the definite integral of a function, usually via a weighted sum of function values at specified points within the domain of integration. An \(n\)-point Gaussian quadrature rule is a quadrature rule where the approximation is exact for polynomials of degree \(2n - 1\) or less.
A generic \(n\)-point Gaussian quadrature rule for approximating a function \(f(x)\) over its domain \(D\) can be stated as:

\[
\int_D f(x) \ dx \approx \sum_{i = 1} ^ n w_i f(x_i)
\]

If the integrated function can be written as \(f(x) = w(x) g(x)\), the quadrature rule becomes

\[
\int_D f(x) \ dx = \int_D w(x)g(x) \ dx \approx \sum_{i = 1} ^ n w_i g(x_i)
\]

A common weight function \(w(x) = e ^ {-x ^ 2}\) yields a so-called Gauss-Hermite quadrature rule. Further details in @liu_1994.

In the context of parametric survival models with frailty terms, the term we would wish to approximate is the frailty density in the likelihood function. The cluster-specific unconditional likelihood, for Gamma-distributed frailties \((\alpha_i)\), is:

\[
\begin{aligned}
L_i &= \int_0 ^ {+ \infty} L_i(\alpha_i) g(\alpha_i) \ d \alpha_i \\
    &= \int_0 ^ {+ \infty} \alpha_i ^ {D_i} \prod_{j = 1} ^ {n_i} \left[ S_{ij}(t_{ij}) ^ {\alpha_i} h_{ij}(t_{ij}) ^ {d_{ij}} \right] \frac{\alpha_i ^ {1 / \theta - 1} \exp(- \alpha_i / \theta)}{\Gamma(1 / \theta) \theta ^ {1 / \theta}} \ d \alpha_i = \\
    &= \int_0 ^ {+ \infty} \alpha_i ^ {D_i} \prod_{j = 1} ^ {n_i} \left[ \left( \exp \left( -t_{ij} ^ p \exp \left( X_{ij} \beta \right) \right) \right) ^ {\alpha_i} \left( p \lambda t_{ij} ^ {p - 1} \exp \left( X_{ij} \beta \right) \right) ^ {d_{ij}} \right] \times \\
    & \qquad \times \frac{\alpha_i ^ {1 / \theta - 1} \exp(- \alpha_i / \theta)}{\Gamma(1 / \theta) \theta ^ {1 / \theta}} \ d \alpha_i
\end{aligned}
\]

The integral is over the \(0, \  +\infty\) domain, hence we need to apply the so-called Gauss-Laguerre quadrature rule. The Gauss-Laguerre quadrature rule is used to approximate integrals of the kind

\[
\int_0 ^ {+\infty} x ^ \alpha e ^ {-x} f(x) \ dx \approx \sum_{i = 1} ^ n w_i f(x_i),
\]

for some real number \(\alpha > -1\), to handle singularities at \(x = 0\). We will assume \(\alpha = 0\). In our more general function, where it is not straightforward to extract the weight term (i.e. \(e ^ {-\alpha}\)), we apply the following transformation:

\[
\int_0 ^ {+\infty} f(x) \ dx = \int_0 ^ {+\infty} e ^ x e ^ {-x} f(x) \ dx = \int_0 ^ {+\infty} e ^ {-x} g(x) \ dx \approx \sum_{i = 1} ^ n w_i g(x_i)
\]

This approach is analytically valid, but it may not always be numerically stable.

## Parametric survival model with a random treatment effect

In addition to the abovementioned model, we will estimate a Weibull parametric survival model with a Normal-distributed random effect:

\[
h_{ij} = \lambda p t ^ {p - 1} \exp((b_{1i} + \beta_1) X_{1ij}),
\]

with \(i\) identifying the cluster-level and \(j\) identifying the individual-level. This model requires integrating over the random effects to estimate the model parameters. The \(i\)-th cluster contribution to the likelihood is:

\[
\begin{aligned}
L_i &= \int_{-\infty}^{+\infty} \left[ \prod_{j = 1} ^ {n_i} h_{ij}(t_{ij}) ^ {d_{ij}} S_{ij}(t_{ij}) \right] p(b_i) \ db_i = \\
    &= \int_{-\infty}^{+\infty} \left[ \prod_{j = 1} ^ {n_i} \left( \lambda p t_{ij} ^ {p - 1} \exp((b_{1i} + \beta_1) X_{1ij}) \right) ^ {d_{ij}} \left( \exp(-\lambda t_{ij} ^ p \exp((b_{1i} + \beta_1) X_{1ij}) \right) \right] \times \\
    & \qquad \times \frac{1}{\sqrt{2 \sigma ^ 2 \pi}} \ \exp \left( -\frac{b_i ^ 2}{2 \sigma ^ 2} \right) \ db_i = \\
    &= \frac{1}{\sqrt{2 \sigma ^ 2 \pi}} \int_{-\infty}^{+\infty} \left[ \prod_{j = 1} ^ {n_i} \left( \lambda p t_{ij} ^ {p - 1} \exp((b_{1i} + \beta_1) X_{1ij}) \right) ^ {d_{ij}} \left( \exp(-\lambda t_{ij} ^ p \exp((b_{1i} + \beta_1) X_{1ij}) \right) \right] \times \\
    & \qquad \times \exp \left( -\frac{b_i ^ 2}{2 \sigma ^ 2} \right) \ db_i \\
\end{aligned}
\]

# Results

```{r, include = FALSE}
rm(list = ls()); gc()

# Setting knitr options:
if (!requireNamespace("knitr")) install.packages("knitr")
knitr::opts_chunk$set(tidy = TRUE, echo = FALSE, warning = FALSE, fig.width = 8, fig.height = 8)

# Loading packages and data:

if (!requireNamespace("pacman")) install.packages("pacman")
pacman::p_load("dplyr", "tidyr", "ggplot2", "ggthemes", "stringr", "readr", "pracma", "numDeriv", "fastGHQuad", "marqLevAlg")
s_an_vs_gq_vs_int <- lapply(list.files(path = "Results/", pattern = "an_vs_gq_vs_int", full.names = T), readRDS) %>% 
  bind_rows()
s_normal_gq <- lapply(list.files(path = "Results/", pattern = "normal_gq", full.names = T), readRDS) %>% 
  bind_rows()
```

## Analytical formulae against Gaussian quadrature

Additionally, we include as a comparison the `integrate()` function from base-R. The `integrate()` function does, _for a finite interval, globally adaptive interval subdivision [...] in connection with extrapolation by Wynn's Epsilon algorithm, with the basic step being Gaussâ€“Kronrod quadrature_. We compare that function with Gauss-Laguerre quadrature and analytical formulae.

```{r}
s_an_vs_gq_vs_int_summary <- s_an_vs_gq_vs_int %>% 
  mutate(AF_trt_bias = AF_trt - treatment_effect,
         GQ15_trt_bias = GQ15_trt - treatment_effect,
         GQ35_trt_bias = GQ35_trt - treatment_effect,
         GQ75_trt_bias = GQ75_trt - treatment_effect,
         GQ105_trt_bias = GQ105_trt - treatment_effect,
         IN_trt_bias = IN_trt - treatment_effect,
         AF_theta_bias = AF_theta - log(frailty_theta),
         GQ15_theta_bias = GQ15_theta - log(frailty_theta),
         GQ35_theta_bias = GQ35_theta - log(frailty_theta),
         GQ75_theta_bias = GQ75_theta - log(frailty_theta),
         GQ105_theta_bias = GQ105_theta - log(frailty_theta),
         IN_theta_bias = IN_theta - log(frailty_theta),
         AF_lambda_bias = AF_lambda - log(lambda),
         GQ15_lambda_bias = GQ15_lambda - log(lambda),
         GQ35_lambda_bias = GQ35_lambda - log(lambda),
         GQ75_lambda_bias = GQ75_lambda - log(lambda),
         GQ105_lambda_bias = GQ105_lambda - log(lambda),
         IN_lambda_bias = IN_lambda - log(lambda),
         AF_p_bias = AF_p - log(p),
         GQ15_p_bias = GQ15_p - log(p),
         GQ35_p_bias = GQ35_p - log(p),
         GQ75_p_bias = GQ75_p - log(p),
         GQ105_p_bias = GQ105_p - log(p),
         IN_p_bias = IN_p - log(p),
         AF_trt_pbias = (exp(AF_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ15_trt_pbias = (exp(GQ15_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ35_trt_pbias = (exp(GQ35_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ75_trt_pbias = (exp(GQ75_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ105_trt_pbias = (exp(GQ105_trt) - exp(treatment_effect)) / exp(treatment_effect),
         IN_trt_pbias = (exp(IN_trt) - exp(treatment_effect)) / exp(treatment_effect),
         AF_theta_pbias = (exp(AF_theta) - frailty_theta) / frailty_theta,
         GQ15_theta_pbias = (exp(GQ15_theta) - frailty_theta) / frailty_theta,
         GQ35_theta_pbias = (exp(GQ35_theta) - frailty_theta) / frailty_theta,
         GQ75_theta_pbias = (exp(GQ75_theta) - frailty_theta) / frailty_theta,
         GQ105_theta_pbias = (exp(GQ105_theta) - frailty_theta) / frailty_theta,
         IN_theta_pbias = (exp(IN_theta) - frailty_theta) / frailty_theta,
         AF_lambda_pbias = (exp(AF_lambda) - lambda) / lambda,
         GQ15_lambda_pbias = (exp(GQ15_lambda) - lambda) / lambda,
         GQ35_lambda_pbias = (exp(GQ35_lambda) - lambda) / lambda,
         GQ75_lambda_pbias = (exp(GQ75_lambda) - lambda) / lambda,
         GQ105_lambda_pbias = (exp(GQ105_lambda) - lambda) / lambda,
         IN_lambda_pbias = (exp(IN_lambda) - lambda) / lambda,
         AF_p_pbias = (exp(AF_p) - p) / p,
         GQ15_p_pbias = (exp(GQ15_p) - p) / p,
         GQ35_p_pbias = (exp(GQ35_p) - p) / p,
         GQ75_p_pbias = (exp(GQ75_p) - p) / p,
         GQ105_p_pbias = (exp(GQ105_p) - p) / p,
         IN_p_pbias = (exp(IN_p) - p) / p,
         AF_trt_covp = ifelse(treatment_effect >= (AF_trt - AF_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (AF_trt + AF_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_trt_covp = ifelse(treatment_effect >= (GQ15_trt - GQ15_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ15_trt + GQ15_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_trt_covp = ifelse(treatment_effect >= (GQ35_trt - GQ35_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ35_trt + GQ35_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_trt_covp = ifelse(treatment_effect >= (GQ75_trt - GQ75_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ75_trt + GQ75_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_trt_covp = ifelse(treatment_effect >= (GQ105_trt - GQ105_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ105_trt + GQ105_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         IN_trt_covp = ifelse(treatment_effect >= (IN_trt - IN_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (IN_trt + IN_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         AF_theta_covp = ifelse(log(frailty_theta) >= (AF_theta - AF_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (AF_theta + AF_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_theta_covp = ifelse(log(frailty_theta) >= (GQ15_theta - GQ15_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (GQ15_theta + GQ15_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_theta_covp = ifelse(log(frailty_theta) >= (GQ35_theta - GQ35_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (GQ35_theta + GQ35_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_theta_covp = ifelse(log(frailty_theta) >= (GQ75_theta - GQ75_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (GQ75_theta + GQ75_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_theta_covp = ifelse(log(frailty_theta) >= (GQ105_theta - GQ105_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (GQ105_theta + GQ105_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         IN_theta_covp = ifelse(log(frailty_theta) >= (IN_theta - IN_theta_se * qnorm(1 - 0.05/2)) & log(frailty_theta) <= (IN_theta + IN_theta_se * qnorm(1 - 0.05/2)), 1, 0),
         AF_lambda_covp = ifelse(log(lambda) >= (AF_lambda - AF_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (AF_lambda + AF_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_lambda_covp = ifelse(log(lambda) >= (GQ15_lambda - GQ15_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ15_lambda + GQ15_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_lambda_covp = ifelse(log(lambda) >= (GQ35_lambda - GQ35_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ35_lambda + GQ35_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_lambda_covp = ifelse(log(lambda) >= (GQ75_lambda - GQ75_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ75_lambda + GQ75_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_lambda_covp = ifelse(log(lambda) >= (GQ105_lambda - GQ105_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ105_lambda + GQ105_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         IN_lambda_covp = ifelse(log(lambda) >= (IN_lambda - IN_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (IN_lambda + IN_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         AF_p_covp = ifelse(log(p) >= (AF_p - AF_p_se * qnorm(1 - 0.05/2)) & log(p) <= (AF_p + AF_p_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_p_covp = ifelse(log(p) >= (GQ15_p - GQ15_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ15_p + GQ15_p_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_p_covp = ifelse(log(p) >= (GQ35_p - GQ35_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ35_p + GQ35_p_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_p_covp = ifelse(log(p) >= (GQ75_p - GQ75_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ75_p + GQ75_p_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_p_covp = ifelse(log(p) >= (GQ105_p - GQ105_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ105_p + GQ105_p_se * qnorm(1 - 0.05/2)), 1, 0),
         IN_p_covp = ifelse(log(p) >= (IN_p - IN_p_se * qnorm(1 - 0.05/2)) & log(p) <= (IN_p + IN_p_se * qnorm(1 - 0.05/2)), 1, 0)) %>% 
  group_by(n_individuals, n_clusters, frailty_theta, treatment_effect, lambda, p) %>% 
  summarise(AF_convp = mean(AF_convergence == 0),
            GQ15_convp = mean(GQ15_convergence == 0),
            GQ35_convp = mean(GQ35_convergence == 0),
            GQ75_convp = mean(GQ75_convergence == 0),
            GQ105_convp = mean(GQ105_convergence == 0),
            IN_convp = mean(IN_convergence == 0),
            AF_convn = sum(AF_convergence == 0),
            GQ15_convn = sum(GQ15_convergence == 0),
            GQ35_convn = sum(GQ35_convergence == 0),
            GQ75_convn = sum(GQ75_convergence == 0),
            GQ105_convn = sum(GQ105_convergence == 0),
            IN_convn = sum(IN_convergence == 0),
            AF_trt_mean = mean(AF_trt, na.rm = TRUE),
            GQ15_trt_mean = mean(GQ15_trt, na.rm = TRUE),
            GQ35_trt_mean = mean(GQ35_trt, na.rm = TRUE),
            GQ75_trt_mean = mean(GQ75_trt, na.rm = TRUE),
            GQ105_trt_mean = mean(GQ105_trt, na.rm = TRUE),
            IN_trt_mean = mean(IN_trt, na.rm = TRUE),
            AF_trt_median = median(AF_trt, na.rm = TRUE),
            GQ15_trt_median = median(GQ15_trt, na.rm = TRUE),
            GQ35_trt_median = median(GQ35_trt, na.rm = TRUE),
            GQ75_trt_median = median(GQ75_trt, na.rm = TRUE),
            GQ105_trt_median = median(GQ105_trt, na.rm = TRUE),
            IN_trt_median = median(IN_trt, na.rm = TRUE),
            AF_trt_se_mean = mean(AF_trt_se, na.rm = TRUE),
            GQ15_trt_se_mean = mean(GQ15_trt_se, na.rm = TRUE),
            GQ35_trt_se_mean = mean(GQ35_trt_se, na.rm = TRUE),
            GQ75_trt_se_mean = mean(GQ75_trt_se, na.rm = TRUE),
            GQ105_trt_se_mean = mean(GQ105_trt_se, na.rm = TRUE),
            IN_trt_se_mean = mean(IN_trt_se, na.rm = TRUE),
            AF_trt_se_median = median(AF_trt_se, na.rm = TRUE),
            GQ15_trt_se_median = median(GQ15_trt_se, na.rm = TRUE),
            GQ35_trt_se_median = median(GQ35_trt_se, na.rm = TRUE),
            GQ75_trt_se_median = median(GQ75_trt_se, na.rm = TRUE),
            GQ105_trt_se_median = median(GQ105_trt_se, na.rm = TRUE),
            IN_trt_se_median = median(IN_trt_se, na.rm = TRUE),
            AF_trt_empse = sqrt((1 / (n() - 1)) * sum((AF_trt - AF_trt_mean) ^ 2, na.rm = TRUE)),
            GQ15_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ15_trt - GQ15_trt_mean) ^ 2, na.rm = TRUE)),
            GQ35_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ35_trt - GQ35_trt_mean) ^ 2, na.rm = TRUE)),
            GQ75_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ75_trt - GQ75_trt_mean) ^ 2, na.rm = TRUE)),
            GQ105_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ105_trt - GQ105_trt_mean) ^ 2, na.rm = TRUE)),
            IN_trt_empse = sqrt((1 / (n() - 1)) * sum((IN_trt - IN_trt_mean) ^ 2, na.rm = TRUE)),
            AF_trt_bias = mean(AF_trt_bias, na.rm = TRUE),
            GQ15_trt_bias = mean(GQ15_trt_bias, na.rm = TRUE),
            GQ35_trt_bias = mean(GQ35_trt_bias, na.rm = TRUE),
            GQ75_trt_bias = mean(GQ75_trt_bias, na.rm = TRUE),
            GQ105_trt_bias = mean(GQ105_trt_bias, na.rm = TRUE),
            IN_trt_bias = mean(IN_trt_bias, na.rm = TRUE),
            AF_trt_pbias = mean(AF_trt_pbias, na.rm = TRUE),
            GQ15_trt_pbias = mean(GQ15_trt_pbias, na.rm = TRUE),
            GQ35_trt_pbias = mean(GQ35_trt_pbias, na.rm = TRUE),
            GQ75_trt_pbias = mean(GQ75_trt_pbias, na.rm = TRUE),
            GQ105_trt_pbias = mean(GQ105_trt_pbias, na.rm = TRUE),
            IN_trt_pbias = mean(IN_trt_pbias, na.rm = TRUE),
            AF_trt_covp = mean(AF_trt_covp, na.rm = TRUE),
            GQ15_trt_covp = mean(GQ15_trt_covp, na.rm = TRUE),
            GQ35_trt_covp = mean(GQ35_trt_covp, na.rm = TRUE),
            GQ75_trt_covp = mean(GQ75_trt_covp, na.rm = TRUE),
            GQ105_trt_covp = mean(GQ105_trt_covp, na.rm = TRUE),
            IN_trt_covp = mean(IN_trt_covp, na.rm = TRUE),
            AF_theta_mean = mean(AF_theta, na.rm = TRUE),
            GQ15_theta_mean = mean(GQ15_theta, na.rm = TRUE),
            GQ35_theta_mean = mean(GQ35_theta, na.rm = TRUE),
            GQ75_theta_mean = mean(GQ75_theta, na.rm = TRUE),
            GQ105_theta_mean = mean(GQ105_theta, na.rm = TRUE),
            IN_theta_mean = mean(IN_theta, na.rm = TRUE),
            AF_theta_median = median(AF_theta, na.rm = TRUE),
            GQ15_theta_median = median(GQ15_theta, na.rm = TRUE),
            GQ35_theta_median = median(GQ35_theta, na.rm = TRUE),
            GQ75_theta_median = median(GQ75_theta, na.rm = TRUE),
            GQ105_theta_median = median(GQ105_theta, na.rm = TRUE),
            IN_theta_median = median(IN_theta, na.rm = TRUE),
            AF_theta_se_mean = mean(AF_theta_se, na.rm = TRUE),
            GQ15_theta_se_mean = mean(GQ15_theta_se, na.rm = TRUE),
            GQ35_theta_se_mean = mean(GQ35_theta_se, na.rm = TRUE),
            GQ75_theta_se_mean = mean(GQ75_theta_se, na.rm = TRUE),
            GQ105_theta_se_mean = mean(GQ105_theta_se, na.rm = TRUE),
            IN_theta_se_mean = mean(IN_theta_se, na.rm = TRUE),
            AF_theta_se_median = median(AF_theta_se, na.rm = TRUE),
            GQ15_theta_se_median = median(GQ15_theta_se, na.rm = TRUE),
            GQ35_theta_se_median = median(GQ35_theta_se, na.rm = TRUE),
            GQ75_theta_se_median = median(GQ75_theta_se, na.rm = TRUE),
            GQ105_theta_se_median = median(GQ105_theta_se, na.rm = TRUE),
            IN_theta_se_median = median(IN_theta_se, na.rm = TRUE),
            AF_theta_empse = sqrt((1 / (n() - 1)) * sum((AF_theta - AF_theta_mean) ^ 2, na.rm = TRUE)),
            GQ15_theta_empse = sqrt((1 / (n() - 1)) * sum((GQ15_theta - GQ15_theta_mean) ^ 2, na.rm = TRUE)),
            GQ35_theta_empse = sqrt((1 / (n() - 1)) * sum((GQ35_theta - GQ35_theta_mean) ^ 2, na.rm = TRUE)),
            GQ75_theta_empse = sqrt((1 / (n() - 1)) * sum((GQ75_theta - GQ75_theta_mean) ^ 2, na.rm = TRUE)),
            GQ105_theta_empse = sqrt((1 / (n() - 1)) * sum((GQ105_theta - GQ105_theta_mean) ^ 2, na.rm = TRUE)),
            IN_theta_empse = sqrt((1 / (n() - 1)) * sum((IN_theta - IN_theta_mean) ^ 2, na.rm = TRUE)),
            AF_theta_bias = mean(AF_theta_bias, na.rm = TRUE),
            GQ15_theta_bias = mean(GQ15_theta_bias, na.rm = TRUE),
            GQ35_theta_bias = mean(GQ35_theta_bias, na.rm = TRUE),
            GQ75_theta_bias = mean(GQ75_theta_bias, na.rm = TRUE),
            GQ105_theta_bias = mean(GQ105_theta_bias, na.rm = TRUE),
            IN_theta_bias = mean(IN_theta_bias, na.rm = TRUE),
            AF_theta_pbias = mean(AF_theta_pbias, na.rm = TRUE),
            GQ15_theta_pbias = mean(GQ15_theta_pbias, na.rm = TRUE),
            GQ35_theta_pbias = mean(GQ35_theta_pbias, na.rm = TRUE),
            GQ75_theta_pbias = mean(GQ75_theta_pbias, na.rm = TRUE),
            GQ105_theta_pbias = mean(GQ105_theta_pbias, na.rm = TRUE),
            IN_theta_pbias = mean(IN_theta_pbias, na.rm = TRUE),
            AF_theta_covp = mean(AF_theta_covp, na.rm = TRUE),
            GQ15_theta_covp = mean(GQ15_theta_covp, na.rm = TRUE),
            GQ35_theta_covp = mean(GQ35_theta_covp, na.rm = TRUE),
            GQ75_theta_covp = mean(GQ75_theta_covp, na.rm = TRUE),
            GQ105_theta_covp = mean(GQ105_theta_covp, na.rm = TRUE),
            IN_theta_covp = mean(IN_theta_covp, na.rm = TRUE),
            AF_lambda_mean = mean(AF_lambda, na.rm = TRUE),
            GQ15_lambda_mean = mean(GQ15_lambda, na.rm = TRUE),
            GQ35_lambda_mean = mean(GQ35_lambda, na.rm = TRUE),
            GQ75_lambda_mean = mean(GQ75_lambda, na.rm = TRUE),
            GQ105_lambda_mean = mean(GQ105_lambda, na.rm = TRUE),
            IN_lambda_mean = mean(IN_lambda, na.rm = TRUE),
            AF_lambda_median = median(AF_lambda, na.rm = TRUE),
            GQ15_lambda_median = median(GQ15_lambda, na.rm = TRUE),
            GQ35_lambda_median = median(GQ35_lambda, na.rm = TRUE),
            GQ75_lambda_median = median(GQ75_lambda, na.rm = TRUE),
            GQ105_lambda_median = median(GQ105_lambda, na.rm = TRUE),
            IN_lambda_median = median(IN_lambda, na.rm = TRUE),
            AF_lambda_se_mean = mean(AF_lambda_se, na.rm = TRUE),
            GQ15_lambda_se_mean = mean(GQ15_lambda_se, na.rm = TRUE),
            GQ35_lambda_se_mean = mean(GQ35_lambda_se, na.rm = TRUE),
            GQ75_lambda_se_mean = mean(GQ75_lambda_se, na.rm = TRUE),
            GQ105_lambda_se_mean = mean(GQ105_lambda_se, na.rm = TRUE),
            IN_lambda_se_mean = mean(IN_lambda_se, na.rm = TRUE),
            AF_lambda_se_median = median(AF_lambda_se, na.rm = TRUE),
            GQ15_lambda_se_median = median(GQ15_lambda_se, na.rm = TRUE),
            GQ35_lambda_se_median = median(GQ35_lambda_se, na.rm = TRUE),
            GQ75_lambda_se_median = median(GQ75_lambda_se, na.rm = TRUE),
            GQ105_lambda_se_median = median(GQ105_lambda_se, na.rm = TRUE),
            IN_lambda_se_median = median(IN_lambda_se, na.rm = TRUE),
            AF_lambda_empse = sqrt((1 / (n() - 1)) * sum((AF_lambda - AF_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ15_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ15_lambda - GQ15_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ35_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ35_lambda - GQ35_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ75_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ75_lambda - GQ75_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ105_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ105_lambda - GQ105_lambda_mean) ^ 2, na.rm = TRUE)),
            IN_lambda_empse = sqrt((1 / (n() - 1)) * sum((IN_lambda - IN_lambda_mean) ^ 2, na.rm = TRUE)),
            AF_lambda_bias = mean(AF_lambda_bias, na.rm = TRUE),
            GQ15_lambda_bias = mean(GQ15_lambda_bias, na.rm = TRUE),
            GQ35_lambda_bias = mean(GQ35_lambda_bias, na.rm = TRUE),
            GQ75_lambda_bias = mean(GQ75_lambda_bias, na.rm = TRUE),
            GQ105_lambda_bias = mean(GQ105_lambda_bias, na.rm = TRUE),
            IN_lambda_bias = mean(IN_lambda_bias, na.rm = TRUE),
            AF_lambda_pbias = mean(AF_lambda_pbias, na.rm = TRUE),
            GQ15_lambda_pbias = mean(GQ15_lambda_pbias, na.rm = TRUE),
            GQ35_lambda_pbias = mean(GQ35_lambda_pbias, na.rm = TRUE),
            GQ75_lambda_pbias = mean(GQ75_lambda_pbias, na.rm = TRUE),
            GQ105_lambda_pbias = mean(GQ105_lambda_pbias, na.rm = TRUE),
            IN_lambda_pbias = mean(IN_lambda_pbias, na.rm = TRUE),
            AF_lambda_covp = mean(AF_lambda_covp, na.rm = TRUE),
            GQ15_lambda_covp = mean(GQ15_lambda_covp, na.rm = TRUE),
            GQ35_lambda_covp = mean(GQ35_lambda_covp, na.rm = TRUE),
            GQ75_lambda_covp = mean(GQ75_lambda_covp, na.rm = TRUE),
            GQ105_lambda_covp = mean(GQ105_lambda_covp, na.rm = TRUE),
            IN_lambda_covp = mean(IN_lambda_covp, na.rm = TRUE),
            AF_p_mean = mean(AF_p, na.rm = TRUE),
            GQ15_p_mean = mean(GQ15_p, na.rm = TRUE),
            GQ35_p_mean = mean(GQ35_p, na.rm = TRUE),
            GQ75_p_mean = mean(GQ75_p, na.rm = TRUE),
            GQ105_p_mean = mean(GQ105_p, na.rm = TRUE),
            IN_p_mean = mean(IN_p, na.rm = TRUE),
            AF_p_median = median(AF_p, na.rm = TRUE),
            GQ15_p_median = median(GQ15_p, na.rm = TRUE),
            GQ35_p_median = median(GQ35_p, na.rm = TRUE),
            GQ75_p_median = median(GQ75_p, na.rm = TRUE),
            GQ105_p_median = median(GQ105_p, na.rm = TRUE),
            IN_p_median = median(IN_p, na.rm = TRUE),
            AF_p_se_mean = mean(AF_p_se, na.rm = TRUE),
            GQ15_p_se_mean = mean(GQ15_p_se, na.rm = TRUE),
            GQ35_p_se_mean = mean(GQ35_p_se, na.rm = TRUE),
            GQ75_p_se_mean = mean(GQ75_p_se, na.rm = TRUE),
            GQ105_p_se_mean = mean(GQ105_p_se, na.rm = TRUE),
            IN_p_se_mean = mean(IN_p_se, na.rm = TRUE),
            AF_p_se_median = median(AF_p_se, na.rm = TRUE),
            GQ15_p_se_median = median(GQ15_p_se, na.rm = TRUE),
            GQ35_p_se_median = median(GQ35_p_se, na.rm = TRUE),
            GQ75_p_se_median = median(GQ75_p_se, na.rm = TRUE),
            GQ105_p_se_median = median(GQ105_p_se, na.rm = TRUE),
            IN_p_se_median = median(IN_p_se, na.rm = TRUE),
            AF_p_empse = sqrt((1 / (n() - 1)) * sum((AF_p - AF_p_mean) ^ 2, na.rm = TRUE)),
            GQ15_p_empse = sqrt((1 / (n() - 1)) * sum((GQ15_p - GQ15_p_mean) ^ 2, na.rm = TRUE)),
            GQ35_p_empse = sqrt((1 / (n() - 1)) * sum((GQ35_p - GQ35_p_mean) ^ 2, na.rm = TRUE)),
            GQ75_p_empse = sqrt((1 / (n() - 1)) * sum((GQ75_p - GQ75_p_mean) ^ 2, na.rm = TRUE)),
            GQ105_p_empse = sqrt((1 / (n() - 1)) * sum((GQ105_p - GQ105_p_mean) ^ 2, na.rm = TRUE)),
            IN_p_empse = sqrt((1 / (n() - 1)) * sum((IN_p - IN_p_mean) ^ 2, na.rm = TRUE)),
            AF_p_bias = mean(AF_p_bias, na.rm = TRUE),
            GQ15_p_bias = mean(GQ15_p_bias, na.rm = TRUE),
            GQ35_p_bias = mean(GQ35_p_bias, na.rm = TRUE),
            GQ75_p_bias = mean(GQ75_p_bias, na.rm = TRUE),
            GQ105_p_bias = mean(GQ105_p_bias, na.rm = TRUE),
            IN_p_bias = mean(IN_p_bias, na.rm = TRUE),
            AF_p_pbias = mean(AF_p_pbias, na.rm = TRUE),
            GQ15_p_pbias = mean(GQ15_p_pbias, na.rm = TRUE),
            GQ35_p_pbias = mean(GQ35_p_pbias, na.rm = TRUE),
            GQ75_p_pbias = mean(GQ75_p_pbias, na.rm = TRUE),
            GQ105_p_pbias = mean(GQ105_p_pbias, na.rm = TRUE),
            IN_p_pbias = mean(IN_p_pbias, na.rm = TRUE),
            AF_p_covp = mean(AF_p_covp, na.rm = TRUE),
            GQ15_p_covp = mean(GQ15_p_covp, na.rm = TRUE), 
            GQ35_p_covp = mean(GQ35_p_covp, na.rm = TRUE), 
            GQ75_p_covp = mean(GQ75_p_covp, na.rm = TRUE), 
            GQ105_p_covp = mean(GQ105_p_covp, na.rm = TRUE), 
            IN_p_covp = mean(IN_p_covp, na.rm = TRUE)) %>% 
  mutate(AF_trt_mse = AF_trt_bias ^ 2 + AF_trt_empse ^ 2,
         GQ15_trt_mse = GQ15_trt_bias ^ 2 + GQ15_trt_empse ^ 2,
         GQ35_trt_mse = GQ35_trt_bias ^ 2 + GQ35_trt_empse ^ 2,
         GQ75_trt_mse = GQ75_trt_bias ^ 2 + GQ75_trt_empse ^ 2,
         GQ105_trt_mse = GQ105_trt_bias ^ 2 + GQ105_trt_empse ^ 2,
         IN_trt_mse = IN_trt_bias ^ 2 + IN_trt_empse ^ 2,
         AF_theta_mse = AF_theta_bias ^ 2 + AF_theta_empse ^ 2,
         GQ15_theta_mse = GQ15_theta_bias ^ 2 + GQ15_theta_empse ^ 2,
         GQ35_theta_mse = GQ35_theta_bias ^ 2 + GQ35_theta_empse ^ 2,
         GQ75_theta_mse = GQ75_theta_bias ^ 2 + GQ75_theta_empse ^ 2,
         GQ105_theta_mse = GQ105_theta_bias ^ 2 + GQ105_theta_empse ^ 2,
         IN_theta_mse = IN_theta_bias ^ 2 + IN_theta_empse ^ 2,
         AF_lambda_mse = AF_lambda_bias ^ 2 + AF_lambda_empse ^ 2,
         GQ15_lambda_mse = GQ15_lambda_bias ^ 2 + GQ15_lambda_empse ^ 2,
         GQ35_lambda_mse = GQ35_lambda_bias ^ 2 + GQ35_lambda_empse ^ 2,
         GQ75_lambda_mse = GQ75_lambda_bias ^ 2 + GQ75_lambda_empse ^ 2,
         GQ105_lambda_mse = GQ105_lambda_bias ^ 2 + GQ105_lambda_empse ^ 2,
         IN_lambda_mse = IN_lambda_bias ^ 2 + IN_lambda_empse ^ 2,
         AF_p_mse = AF_p_bias ^ 2 + AF_p_empse ^ 2,
         GQ15_p_mse = GQ15_p_bias ^ 2 + GQ15_p_empse ^ 2,
         GQ35_p_mse = GQ35_p_bias ^ 2 + GQ35_p_empse ^ 2,
         GQ75_p_mse = GQ75_p_bias ^ 2 + GQ75_p_empse ^ 2,
         GQ105_p_mse = GQ105_p_bias ^ 2 + GQ105_p_empse ^ 2,
         IN_p_mse = IN_p_bias ^ 2 + IN_p_empse ^ 2)

saveRDS(s_an_vs_gq_vs_int_summary, "SiReX/s_an_vs_gq_vs_int_summary.RDS")

r_an_vs_gq_vs_int <- s_an_vs_gq_vs_int_summary %>%
  gather(key = key, value = value, 7:234) %>%
  separate(key, c("method", "name", "stat"), sep = "_", extra = "merge") %>%
  mutate(stat = ifelse(is.na(stat), name, stat),
         method = factor(method, levels = c("AF", "GQ15", "GQ35", "GQ75", "GQ105", "IN")))
```

### Convergence

Number of simulations converging:

```{r}
# By n_individuals:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(n_individuals), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of individuals per cluster", y = "N. of simulations converging", color = "")

# By n_clusters:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(n_clusters), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of clusters", y = "N. of simulations converging", color = "")

# By treatment_effect:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(treatment_effect), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_brewer(type = "qual", palette = "Set1") + 
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Treatment effect", y = "N. of simulations converging", color = "")

# By frailty_theta:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(frailty_theta), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_brewer(type = "qual", palette = "Set1") + 
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Frailty variance", y = "N. of simulations converging", color = "")
```

Proportion of simulations converging:

```{r}
# By n_individuals:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(n_individuals), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of individuals per cluster", y = "P. of simulations converging", color = "")

# By n_clusters:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(n_clusters), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of clusters", y = "P. of simulations converging", color = "")

# By treatment_effect:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(treatment_effect), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Treatment effect", y = "P. of simulations converging", color = "")

# By frailty_theta:
r_an_vs_gq_vs_int %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(frailty_theta), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Frailty variance", y = "P. of simulations converging", color = "")
```

### Estimated values

Average values:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^mean", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Estimates (Mean)", color = "")
```

Median values:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^median", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Estimates (Median)", color = "")
```

### Bias

Overall:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by treatment effect:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by frailty variance:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ frailty_theta) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by number of clusters:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by number of individuals:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

### Percentage bias

Overall:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>%
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by treatment effect:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by frailty variance:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ frailty_theta) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by number of clusters:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by number of individuals:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(1, 1), legend.justification = c(1, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

### Coverage probability

Overall:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by treatment effect:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by frailty variance:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ frailty_theta) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by number of clusters:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by number of individuals:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

### Standard errors

Average standard errors:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^se_mean", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "SE (Mean)", color = "")
```

Median standard errors:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^se_median", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "SE (Median)", color = "")
```

Empirical standard errors:

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^empse", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Empirical SE", color = "")
```

### Mean square error

```{r}
r_an_vs_gq_vs_int %>% 
  filter(grepl("^mse", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "theta", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "MSE", color = "")
```

## Gaussian quadrature with Normal frailty

```{r}
# Process the results and compute statistics of interest:
s_normal_gq_summary <- s_normal_gq %>% 
  gather(key = key, value = value, 9:18) %>% 
  separate(key, c("a", "b"), sep = "_", extra = "merge") %>% 
  mutate(key = paste0(a, ngh, "_", b)) %>%
  select(-ngh, -a, -b) %>% 
  spread(key = key, value = value) %>% 
  group_by(seed, n_individuals, n_clusters, frailty_sigma, treatment_effect, lambda, p) %>%
  arrange(seed) %>% 
  ungroup()

s_normal_gq_summary <- s_normal_gq_summary %>% 
  mutate(GQ15_trt_bias = GQ15_trt - treatment_effect,
         GQ35_trt_bias = GQ35_trt - treatment_effect,
         GQ75_trt_bias = GQ75_trt - treatment_effect,
         GQ105_trt_bias = GQ105_trt - treatment_effect,
         GQ15_sigma_bias = GQ15_sigma - log(frailty_sigma),
         GQ35_sigma_bias = GQ35_sigma - log(frailty_sigma),
         GQ75_sigma_bias = GQ75_sigma - log(frailty_sigma),
         GQ105_sigma_bias = GQ105_sigma - log(frailty_sigma),
         GQ15_lambda_bias = GQ15_lambda - log(lambda),
         GQ35_lambda_bias = GQ35_lambda - log(lambda),
         GQ75_lambda_bias = GQ75_lambda - log(lambda),
         GQ105_lambda_bias = GQ105_lambda - log(lambda),
         GQ15_p_bias = GQ15_p - log(p),
         GQ35_p_bias = GQ35_p - log(p),
         GQ75_p_bias = GQ75_p - log(p),
         GQ105_p_bias = GQ105_p - log(p),
         GQ15_trt_pbias = (exp(GQ15_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ35_trt_pbias = (exp(GQ35_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ75_trt_pbias = (exp(GQ75_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ105_trt_pbias = (exp(GQ105_trt) - exp(treatment_effect)) / exp(treatment_effect),
         GQ15_sigma_pbias = (exp(GQ15_sigma) - frailty_sigma) / frailty_sigma,
         GQ35_sigma_pbias = (exp(GQ35_sigma) - frailty_sigma) / frailty_sigma,
         GQ75_sigma_pbias = (exp(GQ75_sigma) - frailty_sigma) / frailty_sigma,
         GQ105_sigma_pbias = (exp(GQ105_sigma) - frailty_sigma) / frailty_sigma,
         GQ15_lambda_pbias = (exp(GQ15_lambda) - lambda) / lambda,
         GQ35_lambda_pbias = (exp(GQ35_lambda) - lambda) / lambda,
         GQ75_lambda_pbias = (exp(GQ75_lambda) - lambda) / lambda,
         GQ105_lambda_pbias = (exp(GQ105_lambda) - lambda) / lambda,
         GQ15_p_pbias = (exp(GQ15_p) - p) / p,
         GQ35_p_pbias = (exp(GQ35_p) - p) / p,
         GQ75_p_pbias = (exp(GQ75_p) - p) / p,
         GQ105_p_pbias = (exp(GQ105_p) - p) / p,
         GQ15_trt_covp = ifelse(treatment_effect >= (GQ15_trt - GQ15_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ15_trt + GQ15_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_trt_covp = ifelse(treatment_effect >= (GQ35_trt - GQ35_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ35_trt + GQ35_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_trt_covp = ifelse(treatment_effect >= (GQ75_trt - GQ75_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ75_trt + GQ75_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_trt_covp = ifelse(treatment_effect >= (GQ105_trt - GQ105_trt_se * qnorm(1 - 0.05/2)) & treatment_effect <= (GQ105_trt + GQ105_trt_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_sigma_covp = ifelse(log(frailty_sigma) >= (GQ15_sigma - GQ15_sigma_se * qnorm(1 - 0.05/2)) & log(frailty_sigma) <= (GQ15_sigma + GQ15_sigma_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_sigma_covp = ifelse(log(frailty_sigma) >= (GQ35_sigma - GQ35_sigma_se * qnorm(1 - 0.05/2)) & log(frailty_sigma) <= (GQ35_sigma + GQ35_sigma_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_sigma_covp = ifelse(log(frailty_sigma) >= (GQ75_sigma - GQ75_sigma_se * qnorm(1 - 0.05/2)) & log(frailty_sigma) <= (GQ75_sigma + GQ75_sigma_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_sigma_covp = ifelse(log(frailty_sigma) >= (GQ105_sigma - GQ105_sigma_se * qnorm(1 - 0.05/2)) & log(frailty_sigma) <= (GQ105_sigma + GQ105_sigma_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_lambda_covp = ifelse(log(lambda) >= (GQ15_lambda - GQ15_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ15_lambda + GQ15_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_lambda_covp = ifelse(log(lambda) >= (GQ35_lambda - GQ35_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ35_lambda + GQ35_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ75_lambda_covp = ifelse(log(lambda) >= (GQ75_lambda - GQ75_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ75_lambda + GQ75_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ105_lambda_covp = ifelse(log(lambda) >= (GQ105_lambda - GQ105_lambda_se * qnorm(1 - 0.05/2)) & log(lambda) <= (GQ105_lambda + GQ105_lambda_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ15_p_covp = ifelse(log(p) >= (GQ15_p - GQ15_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ15_p + GQ15_p_se * qnorm(1 - 0.05/2)), 1, 0),
         GQ35_p_covp = ifelse(log(p) >= (GQ35_p - GQ35_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ35_p + GQ35_p_se * qnorm(1 - 0.05/2)), 1, 0), 
         GQ75_p_covp = ifelse(log(p) >= (GQ75_p - GQ75_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ75_p + GQ75_p_se * qnorm(1 - 0.05/2)), 1, 0), 
         GQ105_p_covp = ifelse(log(p) >= (GQ105_p - GQ105_p_se * qnorm(1 - 0.05/2)) & log(p) <= (GQ105_p + GQ105_p_se * qnorm(1 - 0.05/2)), 1, 0)) %>% 
  group_by(n_individuals, n_clusters, frailty_sigma, treatment_effect, lambda, p) %>% 
  summarise(GQ15_convp = mean(GQ15_convergence == 0, na.rm = TRUE),
            GQ35_convp = mean(GQ35_convergence == 0, na.rm = TRUE),
            GQ75_convp = mean(GQ75_convergence == 0, na.rm = TRUE),
            GQ105_convp = mean(GQ105_convergence == 0, na.rm = TRUE),
            GQ15_convn = sum(GQ15_convergence == 0, na.rm = TRUE),
            GQ35_convn = sum(GQ35_convergence == 0, na.rm = TRUE),
            GQ75_convn = sum(GQ75_convergence == 0, na.rm = TRUE),
            GQ105_convn = sum(GQ105_convergence == 0, na.rm = TRUE),
            GQ15_trt_mean = mean(GQ15_trt, na.rm = TRUE),
            GQ35_trt_mean = mean(GQ35_trt, na.rm = TRUE),
            GQ75_trt_mean = mean(GQ75_trt, na.rm = TRUE),
            GQ105_trt_mean = mean(GQ105_trt, na.rm = TRUE),
            GQ15_trt_median = median(GQ15_trt, na.rm = TRUE),
            GQ35_trt_median = median(GQ35_trt, na.rm = TRUE),
            GQ75_trt_median = median(GQ75_trt, na.rm = TRUE),
            GQ105_trt_median = median(GQ105_trt, na.rm = TRUE),
            GQ15_trt_se_mean = mean(GQ15_trt_se, na.rm = TRUE),
            GQ35_trt_se_mean = mean(GQ35_trt_se, na.rm = TRUE),
            GQ75_trt_se_mean = mean(GQ75_trt_se, na.rm = TRUE),
            GQ105_trt_se_mean = mean(GQ105_trt_se, na.rm = TRUE),
            GQ15_trt_se_median = median(GQ15_trt_se, na.rm = TRUE),
            GQ35_trt_se_median = median(GQ35_trt_se, na.rm = TRUE),
            GQ75_trt_se_median = median(GQ75_trt_se, na.rm = TRUE),
            GQ105_trt_se_median = median(GQ105_trt_se, na.rm = TRUE),
            GQ15_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ15_trt - GQ15_trt_mean) ^ 2, na.rm = TRUE)),
            GQ35_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ35_trt - GQ35_trt_mean) ^ 2, na.rm = TRUE)),
            GQ75_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ75_trt - GQ75_trt_mean) ^ 2, na.rm = TRUE)),
            GQ105_trt_empse = sqrt((1 / (n() - 1)) * sum((GQ105_trt - GQ105_trt_mean) ^ 2, na.rm = TRUE)),
            GQ15_trt_bias = mean(GQ15_trt_bias, na.rm = TRUE),
            GQ35_trt_bias = mean(GQ35_trt_bias, na.rm = TRUE),
            GQ75_trt_bias = mean(GQ75_trt_bias, na.rm = TRUE),
            GQ105_trt_bias = mean(GQ105_trt_bias, na.rm = TRUE),
            GQ15_trt_pbias = mean(GQ15_trt_pbias, na.rm = TRUE),
            GQ35_trt_pbias = mean(GQ35_trt_pbias, na.rm = TRUE),
            GQ75_trt_pbias = mean(GQ75_trt_pbias, na.rm = TRUE),
            GQ105_trt_pbias = mean(GQ105_trt_pbias, na.rm = TRUE),
            GQ15_trt_covp = mean(GQ15_trt_covp, na.rm = TRUE),
            GQ35_trt_covp = mean(GQ35_trt_covp, na.rm = TRUE),
            GQ75_trt_covp = mean(GQ75_trt_covp, na.rm = TRUE),
            GQ105_trt_covp = mean(GQ105_trt_covp, na.rm = TRUE),
            GQ15_sigma_mean = mean(GQ15_sigma, na.rm = TRUE),
            GQ35_sigma_mean = mean(GQ35_sigma, na.rm = TRUE),
            GQ75_sigma_mean = mean(GQ75_sigma, na.rm = TRUE),
            GQ105_sigma_mean = mean(GQ105_sigma, na.rm = TRUE),
            GQ15_sigma_median = median(GQ15_sigma, na.rm = TRUE),
            GQ35_sigma_median = median(GQ35_sigma, na.rm = TRUE),
            GQ75_sigma_median = median(GQ75_sigma, na.rm = TRUE),
            GQ105_sigma_median = median(GQ105_sigma, na.rm = TRUE),
            GQ15_sigma_se_mean = mean(GQ15_sigma_se, na.rm = TRUE),
            GQ35_sigma_se_mean = mean(GQ35_sigma_se, na.rm = TRUE),
            GQ75_sigma_se_mean = mean(GQ75_sigma_se, na.rm = TRUE),
            GQ105_sigma_se_mean = mean(GQ105_sigma_se, na.rm = TRUE),
            GQ15_sigma_se_median = median(GQ15_sigma_se, na.rm = TRUE),
            GQ35_sigma_se_median = median(GQ35_sigma_se, na.rm = TRUE),
            GQ75_sigma_se_median = median(GQ75_sigma_se, na.rm = TRUE),
            GQ105_sigma_se_median = median(GQ105_sigma_se, na.rm = TRUE),
            GQ15_sigma_empse = sqrt((1 / (n() - 1)) * sum((GQ15_sigma - GQ15_sigma_mean) ^ 2, na.rm = TRUE)),
            GQ35_sigma_empse = sqrt((1 / (n() - 1)) * sum((GQ35_sigma - GQ35_sigma_mean) ^ 2, na.rm = TRUE)),
            GQ75_sigma_empse = sqrt((1 / (n() - 1)) * sum((GQ75_sigma - GQ75_sigma_mean) ^ 2, na.rm = TRUE)),
            GQ105_sigma_empse = sqrt((1 / (n() - 1)) * sum((GQ105_sigma - GQ105_sigma_mean) ^ 2, na.rm = TRUE)),
            GQ15_sigma_bias = mean(GQ15_sigma_bias, na.rm = TRUE),
            GQ35_sigma_bias = mean(GQ35_sigma_bias, na.rm = TRUE),
            GQ75_sigma_bias = mean(GQ75_sigma_bias, na.rm = TRUE),
            GQ105_sigma_bias = mean(GQ105_sigma_bias, na.rm = TRUE),
            GQ15_sigma_pbias = mean(GQ15_sigma_pbias, na.rm = TRUE),
            GQ35_sigma_pbias = mean(GQ35_sigma_pbias, na.rm = TRUE),
            GQ75_sigma_pbias = mean(GQ75_sigma_pbias, na.rm = TRUE),
            GQ105_sigma_pbias = mean(GQ105_sigma_pbias, na.rm = TRUE),
            GQ15_sigma_covp = mean(GQ15_sigma_covp, na.rm = TRUE),
            GQ35_sigma_covp = mean(GQ35_sigma_covp, na.rm = TRUE),
            GQ75_sigma_covp = mean(GQ75_sigma_covp, na.rm = TRUE),
            GQ105_sigma_covp = mean(GQ105_sigma_covp, na.rm = TRUE),
            GQ15_lambda_mean = mean(GQ15_lambda, na.rm = TRUE),
            GQ35_lambda_mean = mean(GQ35_lambda, na.rm = TRUE),
            GQ75_lambda_mean = mean(GQ75_lambda, na.rm = TRUE),
            GQ105_lambda_mean = mean(GQ105_lambda, na.rm = TRUE),
            GQ15_lambda_median = median(GQ15_lambda, na.rm = TRUE),
            GQ35_lambda_median = median(GQ35_lambda, na.rm = TRUE),
            GQ75_lambda_median = median(GQ75_lambda, na.rm = TRUE),
            GQ105_lambda_median = median(GQ105_lambda, na.rm = TRUE),
            GQ15_lambda_se_mean = mean(GQ15_lambda_se, na.rm = TRUE),
            GQ35_lambda_se_mean = mean(GQ35_lambda_se, na.rm = TRUE),
            GQ75_lambda_se_mean = mean(GQ75_lambda_se, na.rm = TRUE),
            GQ105_lambda_se_mean = mean(GQ105_lambda_se, na.rm = TRUE),
            GQ15_lambda_se_median = median(GQ15_lambda_se, na.rm = TRUE),
            GQ35_lambda_se_median = median(GQ35_lambda_se, na.rm = TRUE),
            GQ75_lambda_se_median = median(GQ75_lambda_se, na.rm = TRUE),
            GQ105_lambda_se_median = median(GQ105_lambda_se, na.rm = TRUE),
            GQ15_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ15_lambda - GQ15_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ35_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ35_lambda - GQ35_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ75_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ75_lambda - GQ75_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ105_lambda_empse = sqrt((1 / (n() - 1)) * sum((GQ105_lambda - GQ105_lambda_mean) ^ 2, na.rm = TRUE)),
            GQ15_lambda_bias = mean(GQ15_lambda_bias, na.rm = TRUE),
            GQ35_lambda_bias = mean(GQ35_lambda_bias, na.rm = TRUE),
            GQ75_lambda_bias = mean(GQ75_lambda_bias, na.rm = TRUE),
            GQ105_lambda_bias = mean(GQ105_lambda_bias, na.rm = TRUE),
            GQ15_lambda_pbias = mean(GQ15_lambda_pbias, na.rm = TRUE),
            GQ35_lambda_pbias = mean(GQ35_lambda_pbias, na.rm = TRUE),
            GQ75_lambda_pbias = mean(GQ75_lambda_pbias, na.rm = TRUE),
            GQ105_lambda_pbias = mean(GQ105_lambda_pbias, na.rm = TRUE),
            GQ15_lambda_covp = mean(GQ15_lambda_covp, na.rm = TRUE),
            GQ35_lambda_covp = mean(GQ35_lambda_covp, na.rm = TRUE),
            GQ75_lambda_covp = mean(GQ75_lambda_covp, na.rm = TRUE),
            GQ105_lambda_covp = mean(GQ105_lambda_covp, na.rm = TRUE),
            GQ15_p_mean = mean(GQ15_p, na.rm = TRUE),
            GQ35_p_mean = mean(GQ35_p, na.rm = TRUE),
            GQ75_p_mean = mean(GQ75_p, na.rm = TRUE),
            GQ105_p_mean = mean(GQ105_p, na.rm = TRUE),
            GQ15_p_median = median(GQ15_p, na.rm = TRUE),
            GQ35_p_median = median(GQ35_p, na.rm = TRUE),
            GQ75_p_median = median(GQ75_p, na.rm = TRUE),
            GQ105_p_median = median(GQ105_p, na.rm = TRUE),
            GQ15_p_se_mean = mean(GQ15_p_se, na.rm = TRUE),
            GQ35_p_se_mean = mean(GQ35_p_se, na.rm = TRUE),
            GQ75_p_se_mean = mean(GQ75_p_se, na.rm = TRUE),
            G105Q_p_se_mean = mean(GQ105_p_se, na.rm = TRUE),
            GQ15_p_se_median = median(GQ15_p_se, na.rm = TRUE),
            GQ35_p_se_median = median(GQ35_p_se, na.rm = TRUE),
            GQ75_p_se_median = median(GQ75_p_se, na.rm = TRUE),
            GQ105_p_se_median = median(GQ105_p_se, na.rm = TRUE),
            GQ15_p_empse = sqrt((1 / (n() - 1)) * sum((GQ15_p - GQ15_p_mean) ^ 2, na.rm = TRUE)),
            GQ35_p_empse = sqrt((1 / (n() - 1)) * sum((GQ35_p - GQ35_p_mean) ^ 2, na.rm = TRUE)),
            GQ75_p_empse = sqrt((1 / (n() - 1)) * sum((GQ75_p - GQ75_p_mean) ^ 2, na.rm = TRUE)),
            GQ105_p_empse = sqrt((1 / (n() - 1)) * sum((GQ105_p - GQ105_p_mean) ^ 2, na.rm = TRUE)),
            GQ15_p_bias = mean(GQ15_p_bias, na.rm = TRUE),
            GQ35_p_bias = mean(GQ35_p_bias, na.rm = TRUE),
            GQ75_p_bias = mean(GQ75_p_bias, na.rm = TRUE),
            GQ105_p_bias = mean(GQ105_p_bias, na.rm = TRUE),
            GQ15_p_pbias = mean(GQ15_p_pbias, na.rm = TRUE),
            GQ35_p_pbias = mean(GQ35_p_pbias, na.rm = TRUE),
            GQ75_p_pbias = mean(GQ75_p_pbias, na.rm = TRUE),
            GQ105_p_pbias = mean(GQ105_p_pbias, na.rm = TRUE),
            GQ15_p_covp = mean(GQ15_p_covp, na.rm = TRUE), 
            GQ35_p_covp = mean(GQ35_p_covp, na.rm = TRUE), 
            GQ75_p_covp = mean(GQ75_p_covp, na.rm = TRUE), 
            GQ105_p_covp = mean(GQ105_p_covp, na.rm = TRUE)) %>% 
  mutate(GQ15_trt_mse = GQ15_trt_bias ^ 2 + GQ15_trt_empse ^ 2,
         GQ35_trt_mse = GQ35_trt_bias ^ 2 + GQ35_trt_empse ^ 2,
         GQ75_trt_mse = GQ75_trt_bias ^ 2 + GQ75_trt_empse ^ 2,
         GQ105_trt_mse = GQ105_trt_bias ^ 2 + GQ105_trt_empse ^ 2,
         GQ15_sigma_mse = GQ15_sigma_bias ^ 2 + GQ15_sigma_empse ^ 2,
         GQ35_sigma_mse = GQ35_sigma_bias ^ 2 + GQ35_sigma_empse ^ 2,
         GQ75_sigma_mse = GQ75_sigma_bias ^ 2 + GQ75_sigma_empse ^ 2,
         GQ105_sigma_mse = GQ105_sigma_bias ^ 2 + GQ105_sigma_empse ^ 2,
         GQ15_lambda_mse = GQ15_lambda_bias ^ 2 + GQ15_lambda_empse ^ 2,
         GQ35_lambda_mse = GQ35_lambda_bias ^ 2 + GQ35_lambda_empse ^ 2,
         GQ75_lambda_mse = GQ75_lambda_bias ^ 2 + GQ75_lambda_empse ^ 2,
         GQ105_lambda_mse = GQ105_lambda_bias ^ 2 + GQ105_lambda_empse ^ 2,
         GQ15_p_mse = GQ15_p_bias ^ 2 + GQ15_p_empse ^ 2,
         GQ35_p_mse = GQ35_p_bias ^ 2 + GQ35_p_empse ^ 2,
         GQ75_p_mse = GQ75_p_bias ^ 2 + GQ75_p_empse ^ 2,
         GQ105_p_mse = GQ105_p_bias ^ 2 + GQ105_p_empse ^ 2)

saveRDS(s_normal_gq_summary, "SiReX/s_normal_gq_summary.RDS")

r_normal_gq <- s_normal_gq_summary %>%
  gather(key = key, value = value, 7:158) %>%
  separate(key, c("method", "name", "stat"), sep = "_", extra = "merge") %>%
  mutate(stat = ifelse(is.na(stat), name, stat),
         method = factor(method, levels = c("GQ15", "GQ35", "GQ75", "GQ105")))
```

### Convergence

Number of simulations converging:

```{r}
# By n_individuals:
r_normal_gq %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(n_individuals), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of individuals per cluster", y = "N. of simulations converging", color = "")

# By n_clusters:
r_normal_gq %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(n_clusters), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of clusters", y = "N. of simulations converging", color = "")

# By n_individuals x n_clusters
r_normal_gq %>% 
  filter(grepl("^convn", stat)) %>%
  rename(`N. ind` = n_individuals, `N. clusters` = n_clusters) %>% 
  ggplot(aes(x = method, y = value)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  facet_grid(`N. clusters` ~ `N. ind` , labeller = label_both) +
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "N. of simulations converging")

# By treatment_effect:
r_normal_gq %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(treatment_effect), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Treatment effect", y = "N. of simulations converging", color = "")

# By frailty_sigma:
r_normal_gq %>% 
  filter(grepl("^convn", stat)) %>%
  ggplot(aes(x = factor(frailty_sigma), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Frailty variance", y = "N. of simulations converging", color = "")
```

Proportion of simulations converging:

```{r}
# By n_individuals:
r_normal_gq %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(n_individuals), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of individuals per cluster", y = "P. of simulations converging", color = "")

# By n_clusters:
r_normal_gq %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(n_clusters), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "N. of clusters", y = "P. of simulations converging", color = "")

# By n_individuals x n_clusters
r_normal_gq %>% 
  filter(grepl("^convp", stat)) %>%
  rename(`N. ind` = n_individuals, `N. clusters` = n_clusters) %>% 
  ggplot(aes(x = method, y = value)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  facet_grid(`N. clusters` ~ `N. ind` , labeller = label_both) +
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "P. of simulations converging")

# By treatment_effect:
r_normal_gq %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(treatment_effect), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Treatment effect", y = "P. of simulations converging", color = "")

# By frailty_sigma:
r_normal_gq %>% 
  filter(grepl("^convp", stat)) %>%
  ggplot(aes(x = factor(frailty_sigma), y = value, color = method)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "Frailty variance", y = "P. of simulations converging", color = "")
```

### Estimated values

Average values:

```{r}
r_normal_gq %>% 
  filter(grepl("^mean", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Estimates (Mean)", color = "")
```

Median values:

```{r}
r_normal_gq %>% 
  filter(grepl("^median", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Estimates (Median)", color = "")
```

### Bias

Overall:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by treatment effect:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by frailty variance:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ frailty_sigma) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by number of clusters:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

Bias by number of clusters and number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^bias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_grid(n_individuals ~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Bias", color = "")
```

### Percentage bias

Overall:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>%
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by treatment effect:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by frailty variance:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ frailty_sigma) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by number of clusters:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

Percentage bias by number of clusters and number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^pbias", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0, alpha = 3/4) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  facet_grid(n_individuals ~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Percentage bias", color = "")
```

### Coverage probability

Overall:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by treatment effect:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ treatment_effect) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by frailty variance:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ frailty_sigma) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by number of clusters:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_wrap(~ n_individuals) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

Coverage probability by number of clusters and number of individuals:

```{r}
r_normal_gq %>% 
  filter(grepl("^covp", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::percent) + 
  facet_grid(n_individuals ~ n_clusters) +
  theme_bw() + 
  theme(legend.position = c(0, 0), legend.justification = c(0, 0), legend.background = element_blank()) + 
  labs(x = "", y = "Coverage probability", color = "")
```

### Standard errors

Average standard errors:

```{r}
r_normal_gq %>% 
  filter(grepl("^se_mean", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "SE (Mean)", color = "")
```

Median standard errors:

```{r}
r_normal_gq %>% 
  filter(grepl("^se_median", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "SE (Median)", color = "")
```

Empirical standard errors:

```{r}
r_normal_gq %>% 
  filter(grepl("^empse", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "Empirical SE", color = "")
```

### Mean square error

```{r}
r_normal_gq %>% 
  filter(grepl("^mse", stat)) %>% 
  mutate(name = factor(name, levels = c("trt", "sigma", "lambda", "p"), labels = c("Treatment effect", "Frailty variance", "Lambda", "P"))) %>% 
  ggplot(aes(x = method, y = value, color = name)) +
  geom_jitter(height = 0) + 
  geom_boxplot(alpha = 3/4) + 
  scale_color_colorblind() +
  scale_y_continuous(labels = scales::comma) + 
  theme_bw() + 
  theme(legend.position = c(0, 1), legend.justification = c(0, 1), legend.background = element_blank()) + 
  labs(x = "", y = "MSE", color = "")
```

## Application to catheter data

```{r}
catheter <- read_csv("catheter.csv", col_types = "ddddd____")
glimpse(catheter)
```

First, we estimate the effect of age and gender on the risk of infection using a Weibull survival model with a Gamma frailty. We model age per 10-years changes.

We will use the following starting values:

```{r}
catheter$age <- catheter$age / 10
sr <- survival::survreg(survival::Surv(time, infect) ~ age + female, dist = "weibull", data = catheter)
start <- c(log(1 / sr$scale), # p
           log(exp(sr$coef[1]) ^ (-1 / sr$scale)), # lambda
           log(1), # theta
           -sr$coef[2] * (1 / sr$scale), # beta1, coefficient of age, AFT --> PH
           -sr$coef[3] * (1 / sr$scale)) # beta2, coefficient of female, AFT --> PH
names(start) <- c("p", "lambda", "theta", "age", "female")
start
```

Maximising the likelihood using analytical formulae:

```{r, echo = T}
mll <- function(pars) {
  p = exp(pars[1])
  lambda = exp(pars[2])
  theta = exp(pars[3])
  beta1 = pars[4]
  beta2 = pars[5]
  lli = vapply(1:max(catheter$patient),
               FUN = function(i) {
                 log_hi = log(p) + log(lambda) + (p - 1) * log(catheter$time[catheter$patient == i]) + catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2 
                 log_Si = -lambda * catheter$time[catheter$patient == i] ^ p * exp(catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 Di = sum(catheter$infect[catheter$patient == i])
                 lli = sum(catheter$infect[catheter$patient == i] * (log_hi)) - (theta ^ (-1) + Di) * log(1 - theta * sum(log_Si)) + Di * log(theta) + lgamma(theta ^ (-1) + Di) - lgamma(1 / theta) + sum(log(catheter$time[catheter$patient == i]))
                 return(lli)
                 },
               FUN.VALUE = numeric(1))
  ll = sum(lli)
  return(-ll)
}
out <- optim(fn = mll, par = start, hessian = T, method = "BFGS")
out$se = sqrt(diag(solve(out$hessian)))
```

```{r}
all_res <- data.frame(par = names(out$par), est = out$par, se = out$se, lower = out$par - qnorm(1 - 0.05 / 2) * out$se, upper = out$par + qnorm(1 - 0.05 / 2) * out$se, what = "AF")
```

Maximising the likelihood using Gauss-Laguerre quadrature with 15 nodes:

```{r, echo = T}
gl_rule = gaussLaguerre(15)
mll_quad = function(pars) {
  p = exp(pars[1])
  lambda = exp(pars[2])
  theta = exp(pars[3])
  beta1 = pars[4]
  beta2 = pars[5]
  lli = vapply(1:max(catheter$patient),
               FUN = function(i) {
                 log_hi = log(p) + log(lambda) + (p - 1) * log(catheter$time[catheter$patient == i]) + (catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 log_Si = -lambda * catheter$time[catheter$patient == i] ^ p * exp(catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 Di = sum(catheter$infect[catheter$patient == i])
                 intgrdq = function(alpha) exp(alpha + Di * log(alpha) + alpha * sum(log_Si) + (1 / theta - 1) * log(alpha) - alpha / theta)
                 vintgrdq = Vectorize(intgrdq)
                 int = sum(gl_rule$w * vintgrdq(gl_rule$x))
                 ll = sum(catheter$infect[catheter$patient == i] * (log_hi)) - lgamma(1 / theta) - (1 / theta) * log(theta) + log(int) + sum(log(catheter$time[catheter$patient == i]))
                 return(ll)},
               FUN.VALUE = numeric(1))
  ll = sum(lli)
  return(-ll)
}
out_quad <- optim(fn = mll_quad, par = start, hessian = T, method = "BFGS")
out_quad$se <- sqrt(diag(solve(out_quad$hessian)))
```

```{r}
all_res <- bind_rows(all_res,
                     data.frame(par = names(out_quad$par), est = out_quad$par, se = out_quad$se, lower = out_quad$par - qnorm(1 - 0.05 / 2) * out_quad$se, upper = out_quad$par + qnorm(1 - 0.05 / 2) * out_quad$se, what = "GQ15"))
```

Maximising the likelihood using Gauss-Laguerre quadrature with 35 nodes:

```{r, echo = T}
gl_rule = gaussLaguerre(35)
mll_quad2 = function(pars) {
  p = exp(pars[1])
  lambda = exp(pars[2])
  theta = exp(pars[3])
  beta1 = pars[4]
  beta2 = pars[5]
  lli = vapply(1:max(catheter$patient),
               FUN = function(i) {
                 log_hi = log(p) + log(lambda) + (p - 1) * log(catheter$time[catheter$patient == i]) + (catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 log_Si = -lambda * catheter$time[catheter$patient == i] ^ p * exp(catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 Di = sum(catheter$infect[catheter$patient == i])
                 intgrdq = function(alpha) exp(alpha + Di * log(alpha) + alpha * sum(log_Si) + (1 / theta - 1) * log(alpha) - alpha / theta)
                 vintgrdq = Vectorize(intgrdq)
                 int = sum(gl_rule$w * vintgrdq(gl_rule$x))
                 ll = sum(catheter$infect[catheter$patient == i] * (log_hi)) - lgamma(1 / theta) - (1 / theta) * log(theta) + log(int) + sum(log(catheter$time[catheter$patient == i]))
                 return(ll)},
               FUN.VALUE = numeric(1))
  ll = sum(lli)
  return(-ll)
}
out_quad2 <- optim(fn = mll_quad2, par = start, hessian = T, method = "BFGS")
out_quad2$se <- sqrt(diag(solve(out_quad2$hessian)))
```

```{r}
all_res <- bind_rows(all_res,
                     data.frame(par = names(out_quad2$par), est = out_quad2$par, se = out_quad2$se, lower = out_quad2$par - qnorm(1 - 0.05 / 2) * out_quad2$se, upper = out_quad2$par + qnorm(1 - 0.05 / 2) * out_quad2$se, what = "GQ35"))
```

Maximising the likelihood using Gauss-Kronrod quadrature rule (R's `integrate()`):

```{r, echo = T}
mll_int = function(pars) {
  p = exp(pars[1])
  lambda = exp(pars[2])
  theta = exp(pars[3])
  beta1 = pars[4]
  beta2 = pars[5]
  lli = vapply(1:max(catheter$patient),
               FUN = function(i) {
                 log_hi = log(p) + log(lambda) + (p - 1) * log(catheter$time[catheter$patient == i]) + (catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 log_Si = -lambda * catheter$time[catheter$patient == i] ^ p * exp(catheter$age[catheter$patient == i] * beta1 + catheter$female[catheter$patient == i] * beta2)
                 Di = sum(catheter$infect[catheter$patient == i])
                 intgrdq = function(alpha) exp(Di * log(alpha) + alpha * sum(log_Si) + (1 / theta - 1) * log(alpha) - alpha / theta)
                 vintgrdq = Vectorize(intgrdq)
                 int = integrate(vintgrdq, lower = 0, upper = Inf)$value
                 ll = sum(catheter$infect[catheter$patient == i] * (log_hi)) - lgamma(1 / theta) - (1 / theta) * log(theta) + log(int) + sum(log(catheter$time[catheter$patient == i]))
                 return(ll)},
               FUN.VALUE = numeric(1))
  ll = sum(lli)
  return(-ll)
}
out_int <- optim(fn = mll_int, par = start, hessian = T, method = "BFGS")
out_int$se <- sqrt(diag(solve(out_int$hessian)))
```

```{r}
all_res <- bind_rows(all_res,
                     data.frame(par = names(out_int$par), est = out_int$par, se = out_int$se, lower = out_int$par - qnorm(1 - 0.05 / 2) * out_int$se, upper = out_int$par + qnorm(1 - 0.05 / 2) * out_int$se, what = "IN"))
```

Then, we assume a random effect (intercept). We use the same starting values, and we substitute 15-nodes Gauss-Laguerre quadrature for 15-nodes Gauss-Hermite quadrature:

```{r, echo = T}
gh_rule = gaussHermiteData(15)

mll_re = function(pars) {
  p = exp(pars[1])
  lambda = exp(pars[2])
  sigma = exp(pars[3])
  beta1 = pars[4]
  beta2 = pars[5]
  lli = vapply(1:max(catheter$patient),
               FUN = function(i) {
                 intgrd = function(bi) {
                   log_hi = log(p) + log(lambda) + (p - 1) * log(catheter$time[catheter$patient == i]) + catheter$age[catheter$patient == i] * (beta1) + catheter$female[catheter$patient == i] * beta2 + bi
                   log_Si = -lambda * catheter$time[catheter$patient == i] ^ p * exp(catheter$age[catheter$patient == i] * (beta1) + catheter$female[catheter$patient == i] * beta2 + bi)
                   ret = exp(sum(catheter$infect[catheter$patient == i] * (log_hi)) + sum(log_Si))
                   return(ret)}
                 vintgrd = Vectorize(intgrd)
                 int = sum(gh_rule$w / sqrt(pi) * vintgrd(gh_rule$x * sqrt(2) * sigma))
                 ll = log(int) + sum(log(catheter$time[catheter$patient == i]))
                 return(ll)},
               FUN.VALUE = numeric(1))
  ll = sum(lli)
  return(-ll)
}
out_re <- optim(fn = mll_re, par = start, hessian = T, method = "BFGS")
out_re$se <- sqrt(diag(solve(out_re$hessian)))
```

```{r}
all_res <- bind_rows(all_res,
                     data.frame(par = names(out_re$par), est = out_re$par, se = out_re$se, lower = out_re$par - qnorm(1 - 0.05 / 2) * out_re$se, upper = out_re$par + qnorm(1 - 0.05 / 2) * out_re$se, what = "RE"))
```

Comparison of results from the different methods and models:

```{r}
all_res %>% 
  ggplot(aes(x = par, y = est, color = what)) + 
  geom_point(position = position_dodge(0.5)) + 
  geom_errorbar(aes(ymin = lower, ymax = upper), position = position_dodge(0.5), width = 0.25) +
  scale_color_colorblind() +
  theme_bw() + 
  theme(legend.position = c(1, 0), legend.justification = c(1, 0), legend.background = element_blank()) +
  labs(x = "", y = "Estimate", color = "")
```

# References
